---
# Complete NOX VFX Workstation Setup - Everything Included
- name: Complete NOX VFX Workstation Setup
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    # Components to install
    setup_domain: true
    setup_nvidia: true
    setup_software: true
    setup_wallpaper: true
    setup_gnome: true
    
    # NVIDIA configuration
    use_almalinux_native_nvidia: true
    install_cuda: true
    install_nvidia_settings: true
    
  tasks:
    - name: Display NOX VFX complete setup banner
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    NOX VFX COMPLETE SETUP                   â•‘
          â•‘                                                              â•‘
          â•‘  ğŸ¢ Domain Integration: {{ 'Yes' if setup_domain else 'No' }}                              â•‘
          â•‘  ğŸ® NVIDIA/CUDA: {{ 'AlmaLinux Native' if use_almalinux_native_nvidia else 'Traditional' if setup_nvidia else 'No' }}                           â•‘
          â•‘  ğŸ’» Software Stack: {{ 'Yes' if setup_software else 'No' }}                              â•‘
          â•‘  ğŸ¨ NOX Branding: {{ 'Yes' if setup_wallpaper else 'No' }}                                â•‘
          â•‘  ğŸ–¥ï¸ GNOME Config: {{ 'Yes' if setup_gnome else 'No' }}                                 â•‘
          â•‘                                                              â•‘
          â•‘  Target: {{ inventory_hostname }}                            â•‘
          â•‘  This will create a production-ready VFX workstation        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Step 1: Domain Join (if enabled)
- import_playbook: domain-join.yml
  when: setup_domain | default(true)

# Step 2: NVIDIA/CUDA Installation (if enabled)
- import_playbook: software/install-nvidia-almalinux-native.yml
  when: setup_nvidia | default(true) and use_almalinux_native_nvidia | default(true)

- import_playbook: software/install-nvidia-cuda.yml
  when: setup_nvidia | default(true) and not (use_almalinux_native_nvidia | default(true))

# Step 3: Software Installation (if enabled)
- import_playbook: software/install-all-software.yml
  when: setup_software | default(true)

# Step 4: Wallpaper and Branding (if enabled)
- import_playbook: wallpaper.yml
  when: setup_wallpaper | default(true)

# Step 5: GNOME Configuration (if enabled)
- import_playbook: gnome-config.yml
  when: setup_gnome | default(true)

# Final verification and optimization
- name: NOX VFX Complete Setup - Final Steps
  hosts: all
  become: yes
  tasks:
    - name: Run NVIDIA optimizations
      ansible.builtin.shell: /usr/local/bin/nox-nvidia-optimize.sh
      when: setup_nvidia | default(true)
      ignore_errors: yes

    - name: Update GNOME favorites to include NVIDIA Settings
      ansible.builtin.shell: |
        # Add NVIDIA Settings to favorites if NVIDIA is installed
        if command -v nvidia-settings >/dev/null 2>&1; then
          current_favorites=$(gsettings get org.gnome.shell favorite-apps 2>/dev/null || echo "[]")
          if [[ "$current_favorites" != *"nvidia-settings"* ]]; then
            # Add nvidia-settings to the end of favorites
            new_favorites=$(echo "$current_favorites" | sed "s/]/, 'nvidia-settings.desktop']/")
            gsettings set org.gnome.shell favorite-apps "$new_favorites" 2>/dev/null || true
          fi
        fi
      become: no
      when: setup_nvidia | default(true) and setup_gnome | default(true)
      ignore_errors: yes

    - name: Create complete workstation verification script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          echo "=== NOX VFX Complete Workstation Verification ==="
          echo
          
          {% if setup_domain %}
          echo "ğŸ¢ Domain Status:"
          if realm list 2>/dev/null | grep -q "ad.noxvfx.com"; then
              echo "âœ… Joined to ad.noxvfx.com"
          else
              echo "âŒ Not joined to domain"
          fi
          echo
          {% endif %}
          
          {% if setup_nvidia %}
          echo "ğŸ® NVIDIA/CUDA Status:"
          if command -v nvidia-smi >/dev/null 2>&1; then
              echo "âœ… NVIDIA Driver: $(nvidia-smi --query-gpu=driver_version --format=csv,noheader,nounits | head -1)"
              echo "âœ… GPU: $(nvidia-smi --query-gpu=name --format=csv,noheader | head -1)"
              if command -v nvcc >/dev/null 2>&1; then
                  echo "âœ… CUDA: $(nvcc --version | grep "release" | awk '{print $6}' | cut -d',' -f1)"
              fi
          else
              echo "âŒ NVIDIA driver not active (reboot may be required)"
          fi
          echo
          {% endif %}
          
          {% if setup_software %}
          echo "ğŸ’» VFX Software:"
          command -v google-chrome >/dev/null && echo "âœ… Chrome" || echo "âŒ Chrome"
          command -v code >/dev/null && echo "âœ… VS Code" || echo "âŒ VS Code"
          command -v krita >/dev/null && echo "âœ… Krita" || flatpak list | grep -q krita && echo "âœ… Krita (Flatpak)" || echo "âŒ Krita"
          command -v blender >/dev/null && echo "âœ… Blender" || flatpak list | grep -q blender && echo "âœ… Blender (Flatpak)" || echo "âŒ Blender"
          command -v PureRef >/dev/null && echo "âœ… PureRef" || echo "âŒ PureRef"
          flatpak list | grep -q slack && echo "âœ… Slack" || echo "âŒ Slack"
          echo
          {% endif %}
          
          {% if setup_wallpaper %}
          echo "ğŸ¨ NOX Branding:"
          if [ -f "/usr/share/backgrounds/nox-wallpaper.jpg" ]; then
              echo "âœ… NOX wallpaper installed"
          else
              echo "âŒ NOX wallpaper missing"
          fi
          echo
          {% endif %}
          
          {% if setup_gnome %}
          echo "ğŸ–¥ï¸ GNOME Configuration:"
          if [ "$XDG_CURRENT_DESKTOP" = "GNOME" ]; then
              theme=$(gsettings get org.gnome.desktop.interface gtk-theme 2>/dev/null)
              echo "âœ… Theme: $theme"
              favorites=$(gsettings get org.gnome.shell favorite-apps 2>/dev/null)
              if [[ "$favorites" == *"chrome"* ]] && [[ "$favorites" == *"krita"* ]]; then
                  echo "âœ… GNOME favorites configured"
              else
                  echo "âš ï¸ GNOME favorites may need attention"
              fi
          else
              echo "â„¹ï¸ Not in GNOME session"
          fi
          echo
          {% endif %}
          
          echo "ğŸš€ NOX VFX Workstation Status: Ready for Production"
          echo
          echo "ğŸ“‹ Quick Tests:"
          echo "â€¢ NVIDIA: Run 'nvidia-smi' to check GPU status"
          echo "â€¢ Blender: Check CUDA devices in Preferences > System"
          echo "â€¢ Krita: Verify OpenGL in Settings > Configure Krita > Display"
          echo "â€¢ Domain: Try 'id username@ad.noxvfx.com'"
        dest: /usr/local/bin/verify-nox-workstation.sh
        mode: '0755'

    - name: Run complete verification
      ansible.builtin.shell: /usr/local/bin/verify-nox-workstation.sh
      register: workstation_verification
      changed_when: false

    - name: Display verification results
      ansible.builtin.debug:
        msg: "{{ workstation_verification.stdout }}"

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Check if NVIDIA driver needs reboot
      ansible.builtin.shell: nvidia-smi
      register: nvidia_check
      failed_when: false
      changed_when: false
      when: setup_nvidia | default(true)

    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    ğŸ‰ SETUP COMPLETE! ğŸ‰                     â•‘
          â•‘                                                              â•‘
          â•‘  Your NOX VFX workstation is now configured with:           â•‘
          {% if setup_domain %}â•‘  âœ… Domain: ad.noxvfx.com                                    â•‘{% endif %}
          {% if setup_nvidia %}â•‘  âœ… NVIDIA: GPU acceleration ready                          â•‘{% endif %}
          {% if setup_software %}â•‘  âœ… Software: Complete VFX application stack                â•‘{% endif %}
          {% if setup_wallpaper %}â•‘  âœ… Branding: NOX wallpaper and identity                    â•‘{% endif %}
          {% if setup_gnome %}â•‘  âœ… GNOME: Dark theme and VFX-optimized interface          â•‘{% endif %}
          â•‘                                                              â•‘
          {% if (reboot_required_file.stat.exists) or (nvidia_check is defined and nvidia_check.rc != 0) %}â•‘  ğŸ”„ REBOOT REQUIRED to complete NVIDIA driver setup        â•‘{% else %}â•‘  ğŸ¨ Workstation ready for immediate use!                   â•‘{% endif %}
          â•‘                                                              â•‘
          â•‘  Verification: sudo /usr/local/bin/verify-nox-workstation.sh â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Schedule reboot if required
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Rebooting to complete NOX VFX workstation setup"
      when: 
        - reboot_required_file.stat.exists or (nvidia_check is defined and nvidia_check.rc != 0)
        - setup_nvidia | default(true)

# Post-reboot verification (if reboot occurred)
- name: Post-Reboot Verification
  hosts: all
  become: yes
  tasks:
    - name: Wait for system to be ready
      ansible.builtin.wait_for_connection:
        delay: 30
        timeout: 300

    - name: Run final verification after reboot
      ansible.builtin.shell: /usr/local/bin/verify-nox-workstation.sh
      register: final_verification
      changed_when: false

    - name: Display final workstation status
      ansible.builtin.debug:
        msg: |
          ğŸ‰ NOX VFX Workstation Setup Complete!
          
          {{ final_verification.stdout }}
          
          ğŸš€ Your production-ready VFX workstation is online and ready!
          
          ğŸ‘¥ Users can now:
          â€¢ Log in with AD credentials
          â€¢ Access GPU-accelerated VFX applications
          â€¢ Enjoy optimized GNOME interface
          â€¢ Use professional VFX software stack
          
          ğŸ“Š Fleet Management:
          â€¢ Monitor: ansible all -m shell -a 'nvidia-smi --query-gpu=utilization.gpu --format=csv'
          â€¢ Status: ansible all -m shell -a '/usr/local/bin/verify-nox-workstation.sh'
