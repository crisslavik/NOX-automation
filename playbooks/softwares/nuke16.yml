---
- name: Install Foundry Nuke 16.0v6
  hosts: all
  become: yes
  
  vars:
    nuke_version: "16.0v6"
    nuke_install_dir: "/opt"
    nuke_installer: "Nuke{{ nuke_version }}-linux-x86_64.run"
    nuke_installer_path: "../../files/{{ nuke_installer }}"
    nuke_install_path: "{{ nuke_install_dir }}/Nuke{{ nuke_version }}"
    nuke_executable: "{{ nuke_install_path }}/Nuke16.0"
    foundry_license: "5053@license"
    nuke_path: "/mnt/Library/_nox-nuke13"
    ad_home_base: "/home/ad.noxvfx.com"
    
  tasks:
    # Step 1: Install Dependencies
    - name: Install required dependencies
      dnf:
        name:
          - numactl-libs           # Required by Nablet H264 Codec SDK
          - mesa-libGL             # OpenGL library
          - mesa-libGLU            # OpenGL utility library
          - libglvnd-opengl        # Vendor-neutral OpenGL dispatch library (provides libOpenGL.so.0)
          - libglvnd-glx           # GLX support
        state: present
      tags:
        - install
        - dependencies

    # Step 2: Install Nuke
    - name: Copy Nuke installer to target machine
      copy:
        src: "{{ nuke_installer_path }}"
        dest: "/tmp/{{ nuke_installer }}"
        mode: '0755'
      tags:
        - install

    - name: Check if Nuke is already installed
      stat:
        path: "{{ nuke_executable }}"
      register: nuke_installed
      tags:
        - install

    - name: Install Nuke to /opt directory
      command: >
        /tmp/{{ nuke_installer }}
        --prefix={{ nuke_install_dir }}
        --accept-foundry-eula
      when: not nuke_installed.stat.exists
      tags:
        - install

    - name: Remove installer after installation
      file:
        path: "/tmp/{{ nuke_installer }}"
        state: absent
      tags:
        - install

    # Step 3: Configure Environment Variables - System-wide ONLY
    - name: Create Nuke environment configuration script
      copy:
        dest: /etc/profile.d/nuke.sh
        mode: '0644'
        content: |
          # Foundry Nuke Environment Configuration
          export foundry_LICENSE={{ foundry_license }}
          export NUKE_PATH={{ nuke_path }}
      tags:
        - config
        - environment

    # Step 4: Create GNOME Desktop Icons in /etc/skel
    - name: Create .local/share/applications directory in /etc/skel
      file:
        path: /etc/skel/.local/share/applications
        state: directory
        mode: '0755'
      tags:
        - desktop

    - name: Create Nuke desktop entry in /etc/skel
      copy:
        dest: /etc/skel/.local/share/applications/nuke{{ nuke_version }}.desktop
        mode: '0755'
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Nuke {{ nuke_version }}
          Comment=Foundry Nuke Compositor
          Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_executable }} %f
          Icon={{ nuke_install_path }}/plugins/icons/NukeApp256.png
          Terminal=false
          Categories=Graphics;2DGraphics;VFX;
          MimeType=application/x-nuke;
      tags:
        - desktop

    - name: Create NukeX desktop entry in /etc/skel
      copy:
        dest: /etc/skel/.local/share/applications/nukex{{ nuke_version }}.desktop
        mode: '0755'
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=NukeX {{ nuke_version }}
          Comment=Foundry NukeX Compositor
          Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_executable }} --nukex %f
          Icon={{ nuke_install_path }}/plugins/icons/NukeApp256.png
          Terminal=false
          Categories=Graphics;2DGraphics;VFX;
          MimeType=application/x-nuke;
      tags:
        - desktop

    - name: Create Nuke Studio desktop entry in /etc/skel
      copy:
        dest: /etc/skel/.local/share/applications/nukestudio{{ nuke_version }}.desktop
        mode: '0755'
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Nuke Studio {{ nuke_version }}
          Comment=Foundry Nuke Studio
          Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_executable }} --studio %f
          Icon={{ nuke_install_path }}/plugins/icons/NukeApp256.png
          Terminal=false
          Categories=Graphics;2DGraphics;VFX;
          MimeType=application/x-nuke;
      tags:
        - desktop

    # Step 5: Create login script to setup desktop icons for new users
    - name: Create login script to setup desktop icons for new users
      copy:
        dest: /etc/profile.d/setup-nuke-desktop.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Setup Nuke desktop icons on first login
          
          DESKTOP_DIR="$HOME/.local/share/applications"
          SKEL_DESKTOP="/etc/skel/.local/share/applications"
          
          # Only run for AD users
          if [[ "$HOME" == /home/ad.noxvfx.com/* ]]; then
              # Check if desktop directory doesn't exist
              if [ ! -d "$DESKTOP_DIR" ]; then
                  mkdir -p "$DESKTOP_DIR"
                  
                  # Copy all desktop files from /etc/skel if they exist
                  if [ -d "$SKEL_DESKTOP" ]; then
                      cp -n "$SKEL_DESKTOP"/*.desktop "$DESKTOP_DIR/" 2>/dev/null
                      chmod +x "$DESKTOP_DIR"/*.desktop 2>/dev/null
                      update-desktop-database "$DESKTOP_DIR" 2>/dev/null
                  fi
              fi
          fi
      tags:
        - desktop
        - config

    # Step 6: Deploy Desktop Icons to Existing AD Users
    - name: Find all existing AD user home directories
      find:
        paths: "{{ ad_home_base }}"
        file_type: directory
        recurse: no
      register: ad_users
      failed_when: false
      tags:
        - desktop

    - name: Create .local/share/applications for existing users
      file:
        path: "{{ item.path }}/.local/share/applications"
        state: directory
        mode: '0755'
        owner: "{{ item.uid }}"
        group: "{{ item.gid }}"
      loop: "{{ ad_users.files }}"
      when: ad_users.files is defined and ad_users.files | length > 0
      tags:
        - desktop

    - name: Deploy Nuke desktop entry to existing users
      copy:
        src: /etc/skel/.local/share/applications/nuke{{ nuke_version }}.desktop
        dest: "{{ item.path }}/.local/share/applications/nuke{{ nuke_version }}.desktop"
        remote_src: yes
        mode: '0755'
        owner: "{{ item.uid }}"
        group: "{{ item.gid }}"
      loop: "{{ ad_users.files }}"
      when: ad_users.files is defined and ad_users.files | length > 0
      tags:
        - desktop

    - name: Deploy NukeX desktop entry to existing users
      copy:
        src: /etc/skel/.local/share/applications/nukex{{ nuke_version }}.desktop
        dest: "{{ item.path }}/.local/share/applications/nukex{{ nuke_version }}.desktop"
        remote_src: yes
        mode: '0755'
        owner: "{{ item.uid }}"
        group: "{{ item.gid }}"
      loop: "{{ ad_users.files }}"
      when: ad_users.files is defined and ad_users.files | length > 0
      tags:
        - desktop

    - name: Deploy Nuke Studio desktop entry to existing users
      copy:
        src: /etc/skel/.local/share/applications/nukestudio{{ nuke_version }}.desktop
        dest: "{{ item.path }}/.local/share/applications/nukestudio{{ nuke_version }}.desktop"
        remote_src: yes
        mode: '0755'
        owner: "{{ item.uid }}"
        group: "{{ item.gid }}"
      loop: "{{ ad_users.files }}"
      when: ad_users.files is defined and ad_users.files | length > 0
      tags:
        - desktop

    - name: Update desktop database for existing users
      command: update-desktop-database {{ item.path }}/.local/share/applications
      loop: "{{ ad_users.files }}"
      when: ad_users.files is defined and ad_users.files | length > 0
      changed_when: false
      failed_when: false
      tags:
        - desktop

    # Step 7: Verification
    - name: Verify Nuke installation
      command: "{{ nuke_executable }} --version"
      register: nuke_version_output
      changed_when: false
      failed_when: false
      environment:
        foundry_LICENSE: "{{ foundry_license }}"
        NUKE_PATH: "{{ nuke_path }}"
      tags:
        - verify

    - name: Display installation result
      debug:
        msg: |
          Nuke Installation Complete!
          Version: {{ nuke_version_output.stdout | default('Unable to detect') }}
          Installation Path: {{ nuke_executable }}
          License Server: {{ foundry_license }}
          NUKE_PATH: {{ nuke_path }}
      tags:
        - verify
