---
- name: Deploy Autodesk RV 2025 to AlmaLinux 9
  hosts: all
  become: yes
  vars:
    # --- Installation Path Variables ---
    rv_final_path: "/opt/Autodesk/RV-2025.0.0"
    rv_extract_parent_path: "/opt/Autodesk"
    rv_source_zip: "../../Files/RV-Linux-Rocky9-Release-2025.0.0.zip"
  
  tasks:
    - name: Check if RV is already installed
      stat:
        path: "{{ rv_final_path }}/bin/rv"
      register: rv_installed

    - name: Display RV installation status
      debug:
        msg: "{{ '✅ RV already installed at ' + rv_final_path + ' - skipping installation' if rv_installed.stat.exists else '⚙️ RV not found - proceeding with installation' }}"

    - name: 1. Install critical dependencies for RV on AlmaLinux 9
      dnf:
        name:
          - unzip
          - tcsh
          - libglvnd-devel
          - mesa-libGLU
          - ncurses-compat-libs
          - libXcursor
          - xcb-util-cursor
          - qt6-qtbase-gui
          - compat-openssl11
          - pcre-devel
          - libjpeg-turbo-devel
          - libtiff-devel
        state: present
      when: not rv_installed.stat.exists

    - name: 2. Create Autodesk parent directory
      file:
        path: "{{ rv_extract_parent_path }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: not rv_installed.stat.exists

    - name: 3. Copy RV zip file to target machine
      copy:
        src: "{{ rv_source_zip }}"
        dest: "/tmp/RV-Linux-Rocky9-Release-2025.0.0.zip"
        mode: '0644'
      when: not rv_installed.stat.exists

    - name: 4. Extract RV zip file to parent directory
      unarchive:
        src: "/tmp/RV-Linux-Rocky9-Release-2025.0.0.zip"
        dest: "{{ rv_extract_parent_path }}"
        remote_src: yes
      when: not rv_installed.stat.exists

    - name: 5. Rename extracted RV folder to RV-2025.0.0
      command: mv {{ rv_extract_parent_path }}/RV {{ rv_final_path }}
      args:
        creates: "{{ rv_final_path }}"
      when: not rv_installed.stat.exists

    - name: 6. Set ownership and proper permissions on RV directory
      file:
        path: "{{ rv_final_path }}"
        state: directory
        recurse: yes
        mode: 'u=rwX,g=rX,o=rX'
        owner: root
        group: root
      when: not rv_installed.stat.exists

    - name: 7. Ensure RV binaries are executable
      file:
        path: "{{ rv_final_path }}/bin"
        state: directory
        recurse: yes
        mode: 'u=rwx,g=rx,o=rx'
      when: not rv_installed.stat.exists

    - name: 8. Create RV wrapper script (isolates RV environment)
      copy:
        dest: "{{ rv_final_path }}/bin/rv-wrapper"
        mode: '0755'
        content: |
          #!/bin/bash
          # RV Wrapper Script - Sets environment only for RV
          
          export RV_HOME="{{ rv_final_path }}"
          export RV_SUPPORT_PATH=/mnt/Library/pipeline/rv_support_path
          export LD_LIBRARY_PATH=$RV_HOME/lib:$LD_LIBRARY_PATH
          export PATH=$RV_HOME/bin:$PATH
          
          # Launch RV with its environment
          exec "$RV_HOME/bin/rv" "$@"

    - name: 9. Create symbolic link for RV wrapper in /usr/local/bin
      file:
        src: "{{ rv_final_path }}/bin/rv-wrapper"
        dest: /usr/local/bin/rv
        state: link
        force: yes

    - name: 10. Create RV desktop entry for all users
      copy:
        dest: /usr/share/applications/autodesk-rv.desktop
        mode: '0644'
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Autodesk RV
          Comment=Media review and playback software
          Exec={{ rv_final_path }}/bin/rv-wrapper
          Icon={{ rv_final_path }}/resources/RV.icns
          Terminal=false
          Categories=Graphics;Video;AudioVideo;
          StartupNotify=true

    - name: 11. Create RV protocol handler for ShotGrid
      copy:
        dest: /usr/share/applications/rv-protocol.desktop
        mode: '0644'
        content: |
          [Desktop Entry]
          Type=Application
          Name=RV Protocol Handler
          Exec={{ rv_final_path }}/bin/rv-wrapper %u
          MimeType=x-scheme-handler/rv;
          NoDisplay=true

    - name: 12. Register RV protocol handler system-wide
      command: xdg-mime default rv-protocol.desktop x-scheme-handler/rv
      changed_when: false
      ignore_errors: yes

    - name: 13. Update desktop database
      command: update-desktop-database /usr/share/applications/
      changed_when: false

    - name: 14. Remove old global RV environment script if exists
      file:
        path: /etc/profile.d/rv.sh
        state: absent

    - name: 15. Clean up temporary zip file
      file:
        path: "/tmp/RV-Linux-Rocky9-Release-2025.0.0.zip"
        state: absent
      when: not rv_installed.stat.exists

    - name: Final installation status
      debug:
        msg: "{{ '✅ RV 2025.0.0 installed successfully at ' + rv_final_path if not rv_installed.stat.exists else '✅ RV 2025.0.0 already installed - configuration updated' }}"
