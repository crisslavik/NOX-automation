---
# Debug: Show variable values
- name: Debug - Show Nuke installer paths and variables
  ansible.builtin.debug:
    msg: |
      Nuke installer: {{ nuke_installer }}
      Repo dir (nuke): {{ nuke_installer_repo_dir }}
      Repo dir (fallback): {{ nuke_installer_repo_dir_fallback }}
      Foundry license: {{ foundry_license | default('UNDEFINED') }}
      Nuke path: {{ nuke_path | default('UNDEFINED') }}
  tags:
    - install
    - debug

# Step 1: Check if already installed (do this FIRST to avoid unnecessary copying)
- name: Check if Nuke is already installed
  ansible.builtin.stat:
    path: "{{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }}"
  register: nuke_installed
  tags:
    - install

- name: Display Nuke installation status
  ansible.builtin.debug:
    msg: "{{ '✅ Nuke ' + nuke_version + ' already installed - skipping installation' if nuke_installed.stat.exists else '⚙️ Nuke not found - proceeding with installation' }}"
  tags:
    - install

# Step 2: Install Dependencies (only if not installed)
- name: Install required dependencies
  ansible.builtin.dnf:
    name:
      - numactl-libs           # Required by Nablet H264 Codec SDK
      - mesa-libGL             # OpenGL library
      - mesa-libGLU            # OpenGL utility library
      - libglvnd-opengl        # Vendor-neutral OpenGL dispatch library (provides libOpenGL.so.0)
      - libglvnd-glx           # GLX support
    state: present
  when: not nuke_installed.stat.exists
  tags:
    - install
    - dependencies

# Step 3: Ensure installer is available (copy from Files/ on controller - only if not installed)
- name: Check if Nuke installer exists in repository Files/nuke/
  ansible.builtin.stat:
    path: "{{ nuke_installer_repo_dir }}/{{ nuke_installer }}"
  register: nuke_repo_installer
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when: not nuke_installed.stat.exists
  tags:
    - install

- name: Check if Nuke installer exists in repository Files/ (fallback)
  ansible.builtin.stat:
    path: "{{ nuke_installer_repo_dir_fallback }}/{{ nuke_installer }}"
  register: nuke_repo_installer_fallback
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when:
    - not nuke_installed.stat.exists
    - not nuke_repo_installer.stat.exists
  tags:
    - install

- name: Debug - Show installer search results
  ansible.builtin.debug:
    msg: |
      Files/nuke/ check:
        Path: {{ nuke_installer_repo_dir }}/{{ nuke_installer }}
        Exists: {{ nuke_repo_installer.stat.exists | default('SKIPPED') }}
      Files/ fallback check:
        Path: {{ nuke_installer_repo_dir_fallback }}/{{ nuke_installer }}
        Exists: {{ nuke_repo_installer_fallback.stat.exists | default('SKIPPED') }}
  when: not nuke_installed.stat.exists
  tags:
    - install
    - debug

- name: Copy Nuke installer from repository to target (from Files/nuke/)
  ansible.builtin.copy:
    src: "{{ nuke_installer_repo_dir }}/{{ nuke_installer }}"
    dest: "{{ nuke_installer_dir }}/{{ nuke_installer }}"
    mode: '0755'
  when:
    - not nuke_installed.stat.exists
    - nuke_repo_installer.stat.exists
  tags:
    - install

- name: Copy Nuke installer from repository to target (from Files/ fallback)
  ansible.builtin.copy:
    src: "{{ nuke_installer_repo_dir_fallback }}/{{ nuke_installer }}"
    dest: "{{ nuke_installer_dir }}/{{ nuke_installer }}"
    mode: '0755'
  when:
    - not nuke_installed.stat.exists
    - not nuke_repo_installer.stat.exists
    - nuke_repo_installer_fallback.stat.exists is defined
    - nuke_repo_installer_fallback.stat.exists
  tags:
    - install

# Step 4: Verify installer was copied successfully
- name: Verify Nuke installer file is present on target
  ansible.builtin.stat:
    path: "{{ nuke_installer_dir }}/{{ nuke_installer }}"
  register: nuke_installer_stat
  changed_when: false
  tags:
    - install

# Step 5: Install Nuke
- name: Install Nuke to /opt directory (if installer present and not installed)
  ansible.builtin.command: >
    {{ nuke_installer_dir }}/{{ nuke_installer }} --prefix={{ nuke_install_dir }} --accept-foundry-eula
  when:
    - not nuke_installed.stat.exists
    - nuke_installer_stat.stat.exists
  tags:
    - install

- name: Display installation status
  ansible.builtin.debug:
    msg: "{{ '✅ Nuke ' + nuke_version + ' already installed' if nuke_installed.stat.exists else ('⚠️ Nuke installer not found at ' + nuke_installer_dir + '/' + nuke_installer + '. Installation skipped.') if not nuke_installer_stat.stat.exists else '✅ Nuke ' + nuke_version + ' installed successfully' }}"
  tags:
    - install

- name: Remove installer after installation
  ansible.builtin.file:
    path: "{{ nuke_installer_dir }}/{{ nuke_installer }}"
    state: absent
  when: nuke_installer_stat.stat.exists
  tags:
    - install

# Step 4: Configure Environment Variables (IDEMPOTENT - version-specific file)
- name: Remove old generic Nuke environment file (prevent duplicates)
  ansible.builtin.file:
    path: /etc/profile.d/nuke.sh
    state: absent
  tags:
    - config
    - environment

- name: Add foundry_LICENSE environment variable (idempotent)
  ansible.builtin.lineinfile:
    path: "/etc/profile.d/nuke{{ nuke_major_version }}.sh"
    create: yes
    mode: '0644'
    line: "export foundry_LICENSE={{ foundry_license }}"
    regexp: '^export foundry_LICENSE='
  tags:
    - config
    - environment

- name: Add PATH export for Nuke (CRITICAL - required for Nuke to work)
  ansible.builtin.lineinfile:
    path: "/etc/profile.d/nuke{{ nuke_major_version }}.sh"
    create: yes
    mode: '0644'
    line: "export PATH={{ nuke_install_dir }}/Nuke{{ nuke_version }}:$PATH"
    regexp: '^export PATH=.*Nuke.*:\$PATH'
  tags:
    - config
    - environment

- name: Add NUKE_PATH environment variable (idempotent)
  ansible.builtin.lineinfile:
    path: "/etc/profile.d/nuke{{ nuke_major_version }}.sh"
    create: yes
    mode: '0644'
    line: "export NUKE_PATH={{ nuke_path }}"
    regexp: '^export NUKE_PATH='
  tags:
    - config
    - environment

# Step 5: Create GNOME Desktop Icons in /etc/skel
- name: Create .local/share/applications directory in /etc/skel
  ansible.builtin.file:
    path: /etc/skel/.local/share/applications
    state: directory
    mode: '0755'
  tags:
    - desktop

- name: Create Nuke desktop entry in /etc/skel
  ansible.builtin.copy:
    dest: "/etc/skel/.local/share/applications/nuke{{ nuke_major_version }}.desktop"
    mode: '0755'
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Nuke {{ nuke_version }}
      Comment=Foundry Nuke Compositor
      Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }} %f
      Icon={{ nuke_install_dir }}/Nuke{{ nuke_version }}/plugins/icons/NukeApp256.png
      Terminal=false
      Categories=Graphics;2DGraphics;VFX;
      MimeType=application/x-nuke;
  tags:
    - desktop

- name: Create NukeX desktop entry in /etc/skel
  ansible.builtin.copy:
    dest: "/etc/skel/.local/share/applications/nukex{{ nuke_major_version }}.desktop"
    mode: '0755'
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=NukeX {{ nuke_version }}
      Comment=Foundry NukeX Compositor
      Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }} --nukex %f
      Icon={{ nuke_install_dir }}/Nuke{{ nuke_version }}/plugins/icons/NukeApp256.png
      Terminal=false
      Categories=Graphics;2DGraphics;VFX;
      MimeType=application/x-nuke;
  tags:
    - desktop

- name: Create Nuke Studio desktop entry in /etc/skel
  ansible.builtin.copy:
    dest: "/etc/skel/.local/share/applications/nukestudio{{ nuke_major_version }}.desktop"
    mode: '0755'
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Nuke Studio {{ nuke_version }}
      Comment=Foundry Nuke Studio
      Exec=env foundry_LICENSE={{ foundry_license }} NUKE_PATH={{ nuke_path }} {{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }} --studio %f
      Icon={{ nuke_install_dir }}/Nuke{{ nuke_version }}/plugins/icons/NukeApp256.png
      Terminal=false
      Categories=Graphics;2DGraphics;VFX;
      MimeType=application/x-nuke;
  tags:
    - desktop

# Step 6: Deploy Desktop Icons to Existing AD Users
- name: Find all existing AD user home directories
  ansible.builtin.find:
    paths: "{{ ad_home_base }}"
    file_type: directory
    recurse: no
  register: ad_users
  failed_when: false
  tags:
    - desktop

- name: Create .local/share/applications for existing users
  ansible.builtin.file:
    path: "{{ item.path }}/.local/share/applications"
    state: directory
    mode: '0755'
    owner: "{{ item.path | basename }}"
    group: "{{ item.path | basename }}"
  loop: "{{ ad_users.files }}"
  when: ad_users.files is defined and ad_users.files | length > 0
  failed_when: false
  tags:
    - desktop

- name: Deploy Nuke desktop entry to existing users
  ansible.builtin.copy:
    src: "/etc/skel/.local/share/applications/nuke{{ nuke_major_version }}.desktop"
    dest: "{{ item.path }}/.local/share/applications/nuke{{ nuke_major_version }}.desktop"
    remote_src: yes
    mode: '0755'
    owner: "{{ item.path | basename }}"
    group: "{{ item.path | basename }}"
  loop: "{{ ad_users.files }}"
  when: ad_users.files is defined and ad_users.files | length > 0
  failed_when: false
  tags:
    - desktop

- name: Deploy NukeX desktop entry to existing users
  ansible.builtin.copy:
    src: "/etc/skel/.local/share/applications/nukex{{ nuke_major_version }}.desktop"
    dest: "{{ item.path }}/.local/share/applications/nukex{{ nuke_major_version }}.desktop"
    remote_src: yes
    mode: '0755'
    owner: "{{ item.path | basename }}"
    group: "{{ item.path | basename }}"
  loop: "{{ ad_users.files }}"
  when: ad_users.files is defined and ad_users.files | length > 0
  failed_when: false
  tags:
    - desktop

- name: Deploy Nuke Studio desktop entry to existing users
  ansible.builtin.copy:
    src: "/etc/skel/.local/share/applications/nukestudio{{ nuke_major_version }}.desktop"
    dest: "{{ item.path }}/.local/share/applications/nukestudio{{ nuke_major_version }}.desktop"
    remote_src: yes
    mode: '0755'
    owner: "{{ item.path | basename }}"
    group: "{{ item.path | basename }}"
  loop: "{{ ad_users.files }}"
  when: ad_users.files is defined and ad_users.files | length > 0
  failed_when: false
  tags:
    - desktop

- name: Update desktop database for existing users
  ansible.builtin.command: update-desktop-database {{ item.path }}/.local/share/applications
  loop: "{{ ad_users.files }}"
  when: ad_users.files is defined and ad_users.files | length > 0
  changed_when: false
  failed_when: false
  tags:
    - desktop

# Step 7: Verification
- name: Verify Nuke installation
  ansible.builtin.command: "{{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }} --version"
  register: nuke_version_output
  changed_when: false
  failed_when: false
  environment:
    foundry_LICENSE: "{{ foundry_license }}"
    NUKE_PATH: "{{ nuke_path }}"
  when: nuke_installed.stat.exists
  tags:
    - verify

- name: Display installation result
  ansible.builtin.pause:
    seconds: 1
    prompt: |

      ✅ Nuke {{ nuke_version }} Installation Complete!
      Version: {{ nuke_version_output.stdout | default('Unable to detect - may need to login/logout') }}
      Installation Path: {{ nuke_install_dir }}/Nuke{{ nuke_version }}/{{ nuke_executable_name }}
      License Server: {{ foundry_license }}
      NUKE_PATH: {{ nuke_path }}
      ENV File: /etc/profile.d/nuke{{ nuke_major_version }}.sh
  when: nuke_installed.stat.exists
  tags:
    - verify
