---
# Step 1: Check if already installed
- name: Check if Das Element is already installed
  ansible.builtin.command: rpm -q das-element-lite
  register: daselement_installed_check
  failed_when: false
  changed_when: false

- name: Display Das Element installation status
  ansible.builtin.debug:
    msg: "{{ '✅ Das Element already installed - skipping installation' if daselement_installed_check.rc == 0 else '⚙️ Das Element not found - proceeding with installation' }}"

# Step 2: Install dependencies
- name: Install libXScrnSaver dependency
  ansible.builtin.yum:
    name: libXScrnSaver
    state: present
  when: daselement_installed_check.rc != 0

# Step 3: Copy installer from Files/ directory
- name: Check for DasElement installer in repository Files/das-element/
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../Files/das-element/{{ daselement_installer_filename }}"
  register: daselement_repo_installer
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when: daselement_installed_check.rc != 0

- name: Check for DasElement installer in repository Files/ (fallback)
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../Files/{{ daselement_installer_filename }}"
  register: daselement_repo_installer_fallback
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when:
    - daselement_installed_check.rc != 0
    - not daselement_repo_installer.stat.exists

- name: Copy DasElement installer from repository to target (from Files/das-element/)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../Files/das-element/{{ daselement_installer_filename }}"
    dest: "/tmp/{{ daselement_installer_filename }}"
    mode: '0644'
  when:
    - daselement_installed_check.rc != 0
    - daselement_repo_installer.stat.exists

- name: Copy DasElement installer from repository to target (from Files/ fallback)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../Files/{{ daselement_installer_filename }}"
    dest: "/tmp/{{ daselement_installer_filename }}"
    mode: '0644'
  when:
    - daselement_installed_check.rc != 0
    - not daselement_repo_installer.stat.exists
    - daselement_repo_installer_fallback.stat.exists is defined
    - daselement_repo_installer_fallback.stat.exists

# Step 4: Install from RPM
- name: Install DasElement from RPM
  ansible.builtin.dnf:
    name: "/tmp/{{ daselement_installer_filename }}"
    state: present
    disable_gpg_check: yes
  when: daselement_installed_check.rc != 0
  register: daselement_install_result

- name: Remove DasElement installer after installation
  ansible.builtin.file:
    path: "/tmp/{{ daselement_installer_filename }}"
    state: absent
  when: daselement_installed_check.rc != 0

# ========================================
# Lite Version: System-wide Environment
# ========================================
- name: Create system-wide DasElement environment variables (Lite version)
  ansible.builtin.lineinfile:
    path: /etc/profile.d/daselement.sh
    regexp: '^export {{ item.key }}='
    line: 'export {{ item.key }}={{ item.value }}'
    create: yes
    mode: '0644'
  loop:
    - { key: 'DASELEMENT_LICENSE', value: '{{ daselement_license_server }}' }
    - { key: 'DASELEMENT_CONFIG_PATH', value: '{{ daselement_config_path }}' }
    - { key: 'DASELEMENT_RESOURCES', value: '{{ daselement_resources_path }}' }
  when: daselement_variant == 'lite'

- name: Create DasElement configuration wrapper script (Lite version)
  ansible.builtin.copy:
    dest: /usr/local/bin/das-element-lite-wrapper.sh
    mode: '0755'
    force: yes
    content: |
      #!/bin/bash
      # Auto-configure DasElement Lite before launch

      DASELEMENT_DIR="$HOME/.das-element"
      VARIABLES_FILE="$DASELEMENT_DIR/variables.env"

      # Create directory if it doesn't exist
      if [ ! -d "$DASELEMENT_DIR" ]; then
          mkdir -p "$DASELEMENT_DIR"
      fi

      # Always ensure variables.env is correct
      cat > "$VARIABLES_FILE" << 'EOF'
      #### point to the license server
      DASELEMENT_LICENSE={{ daselement_license_server }}

      #### path to the config file (.conf)
      DASELEMENT_CONFIG_PATH={{ daselement_config_path }}

      #### path to the resources folder, for presets, hooks, etc.
      DASELEMENT_RESOURCES={{ daselement_resources_path }}
      EOF

      # Launch DasElement Lite with original binary
      exec {{ daselement_install_path }}/das-element-lite-{{ daselement_lite_version }} "$@"
  when: daselement_variant == 'lite'

- name: Check if DasElement install path exists and is a directory
  ansible.builtin.stat:
    path: "{{ daselement_install_path }}"
  register: daselement_path_check
  when: daselement_variant == 'lite'

- name: Find system-wide DasElement desktop launcher file (Lite version)
  ansible.builtin.find:
    paths: "{{ ['/usr/share/applications'] + ([daselement_install_path] if daselement_path_check.stat.exists and daselement_path_check.stat.isdir else []) }}"
    patterns: '*das-element*.desktop'
    recurse: yes
  register: system_desktop_files
  when: daselement_variant == 'lite'

- name: Update system desktop launcher to use wrapper script (Lite version)
  ansible.builtin.lineinfile:
    path: "{{ item.path }}"
    regexp: '^Exec='
    line: 'Exec=/usr/local/bin/das-element-lite-wrapper.sh'
    backup: yes
  loop: "{{ system_desktop_files.files }}"
  when:
    - daselement_variant == 'lite'
    - system_desktop_files.files | length > 0

- name: Find user-specific desktop launchers (Lite version)
  ansible.builtin.find:
    paths:
      - /home
      - /home/ad.noxvfx.com
    patterns: '*das-element*.desktop'
    recurse: yes
  register: user_desktop_files
  when: daselement_variant == 'lite'

- name: Update user desktop launchers to use wrapper script (Lite version)
  ansible.builtin.lineinfile:
    path: "{{ item.path }}"
    regexp: '^Exec='
    line: 'Exec=/usr/local/bin/das-element-lite-wrapper.sh'
    backup: yes
  loop: "{{ user_desktop_files.files }}"
  when:
    - daselement_variant == 'lite'
    - user_desktop_files.files | length > 0

# ========================================
# Full Version: Per-user Configuration
# ========================================
- name: Create system-wide das-element defaults directory (Full version)
  ansible.builtin.file:
    path: /etc/skel/.das-element
    state: directory
    mode: '0755'
  when: daselement_variant == 'full'

- name: Create default variables.env in /etc/skel for new users (Full version)
  ansible.builtin.copy:
    dest: /etc/skel/.das-element/variables.env
    mode: '0644'
    force: yes
    content: |
      #### point to the license server
      DASELEMENT_LICENSE={{ daselement_license_server }}

      #### path to the config file (.conf)
      DASELEMENT_CONFIG_PATH={{ daselement_config_path }}

      #### path to the resources folder, for presets, hooks, etc.
      DASELEMENT_RESOURCES={{ daselement_resources_path }}
  when: daselement_variant == 'full'

# ========================================
# Common: Update Existing Users
# ========================================
- name: Find all .das-element directories for existing users
  ansible.builtin.find:
    paths:
      - /home
      - /home/ad.noxvfx.com
    patterns: '.das-element'
    file_type: directory
    recurse: yes
    hidden: yes
  register: das_element_dirs

- name: Overwrite variables.env file with environment variables for all existing users
  ansible.builtin.copy:
    dest: "{{ item.path }}/variables.env"
    mode: '0644'
    force: yes
    content: |
      #### point to the license server
      DASELEMENT_LICENSE={{ daselement_license_server }}

      #### path to the config file (.conf)
      DASELEMENT_CONFIG_PATH={{ daselement_config_path }}

      #### path to the resources folder, for presets, hooks, etc.
      DASELEMENT_RESOURCES={{ daselement_resources_path }}
  loop: "{{ das_element_dirs.files }}"
  when: das_element_dirs.files | length > 0
