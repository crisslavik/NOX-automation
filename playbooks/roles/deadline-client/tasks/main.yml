---
# Step 1: Check if already installed
- name: Check if Deadline client is already installed
  ansible.builtin.stat:
    path: "{{ deadline_install_dir }}/bin/deadlinecommand"
  register: deadline_installed

- name: Display Deadline installation status
  ansible.builtin.debug:
    msg: "{{ '✅ Deadline client already installed - skipping installation' if deadline_installed.stat.exists else '⚙️ Deadline client not found - proceeding with installation' }}"

# Step 2: Copy installer from Files/ directory
- name: Check for Deadline installer in repository Files/deadline/
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../Files/deadline/{{ deadline_installer_filename }}"
  register: deadline_repo_installer
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when: not deadline_installed.stat.exists

- name: Check for Deadline installer in repository Files/ (fallback)
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../Files/{{ deadline_installer_filename }}"
  register: deadline_repo_installer_fallback
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false
  when:
    - not deadline_installed.stat.exists
    - deadline_repo_installer.stat.exists is defined
    - not deadline_repo_installer.stat.exists

- name: Copy Deadline installer from repository to target (from Files/deadline/)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../Files/deadline/{{ deadline_installer_filename }}"
    dest: "/tmp/{{ deadline_installer_filename }}"
    mode: '0755'
  when:
    - not deadline_installed.stat.exists
    - deadline_repo_installer.stat.exists

- name: Copy Deadline installer from repository to target (from Files/ fallback)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../Files/{{ deadline_installer_filename }}"
    dest: "/tmp/{{ deadline_installer_filename }}"
    mode: '0755'
  when:
    - not deadline_installed.stat.exists
    - deadline_repo_installer.stat.exists is defined
    - not deadline_repo_installer.stat.exists
    - deadline_repo_installer_fallback.stat.exists is defined
    - deadline_repo_installer_fallback.stat.exists

# Step 3: Install Deadline Client (basic install, connection configured later)
- name: Install Deadline Client in silent mode
  ansible.builtin.command:
    cmd: >
      /tmp/{{ deadline_installer_filename }}
      --mode unattended
      --prefix {{ deadline_install_dir }}
      --slavestartup false
      --launcherstartup false
      --installer-language en
  args:
    creates: "{{ deadline_install_dir }}/bin/deadlinecommand"
  when: not deadline_installed.stat.exists
  register: deadline_install_result

- name: Remove Deadline installer after installation
  ansible.builtin.file:
    path: "/tmp/{{ deadline_installer_filename }}"
    state: absent
  when: not deadline_installed.stat.exists

- name: Display Deadline installation result
  ansible.builtin.debug:
    msg: "{{ '✅ Deadline client installed successfully at ' + deadline_install_dir if not deadline_installed.stat.exists else '✅ Deadline client already installed - configuration updated' }}"

# Step 4: Configure Deadline Repository Connection
- name: Configure Deadline connection to RCS server (SSL with client cert)
  ansible.builtin.shell: |
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ConnectionType Remote
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxyRoot {{ rcs_server }}:{{ rcs_port }}
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxyUseSSL true
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxyValidateCertificate false
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxySSLCertificate "{{ client_cert_path }}"
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting LicenseMode Standard
  environment:
    HOME: /root
  changed_when: true
  when: deadline_use_ssl | default(true) | bool
  ignore_errors: yes

- name: Configure Deadline connection to RCS server (No SSL)
  ansible.builtin.shell: |
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ConnectionType Remote
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxyRoot {{ rcs_server }}:{{ rcs_port }}
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting ProxyUseSSL false
    {{ deadline_install_dir }}/bin/deadlinecommand SetIniFileSetting LicenseMode Standard
  environment:
    HOME: /root
  changed_when: true
  when: not (deadline_use_ssl | default(true) | bool)
  ignore_errors: yes

# Step 5: Add Deadline to system PATH
- name: Add Deadline to system PATH
  ansible.builtin.copy:
    dest: /etc/profile.d/deadline.sh
    mode: '0644'
    content: |
      export DEADLINE_PATH={{ deadline_install_dir }}
      export PATH=$PATH:{{ deadline_install_dir }}/bin

# Step 5b: Ensure render user home directory is correct
- name: Set render user home directory to /var/lib/render
  ansible.builtin.user:
    name: "{{ render_user }}"
    home: /var/lib/{{ render_user }}
    create_home: yes
  failed_when: false

# Step 5c: Create systemd service for Deadline Launcher
- name: Create Deadline Launcher systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/deadline-launcher.service
    mode: '0644'
    content: |
      [Unit]
      Description=Deadline Launcher Service
      After=network.target nfs-client.target
      Wants=network-online.target

      [Service]
      Type=simple
      User={{ render_user }}
      Group={{ render_user }}
      Environment="HOME=/var/lib/{{ render_user }}"
      WorkingDirectory=/var/lib/{{ render_user }}
      ExecStart={{ deadline_install_dir }}/bin/deadlinelauncher -nogui
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal

      # Ensure clean shutdown to release licenses
      TimeoutStopSec=30
      KillMode=mixed
      KillSignal=SIGTERM

      [Install]
      WantedBy=multi-user.target

- name: Create home directory for render user
  ansible.builtin.file:
    path: /var/lib/{{ render_user }}
    state: directory
    owner: "{{ render_user }}"
    group: "{{ render_user }}"
    mode: '0755'

- name: Create Thinkbox/Deadline10 config directory for render user
  ansible.builtin.file:
    path: /var/lib/{{ render_user }}/Thinkbox/Deadline10
    state: directory
    owner: "{{ render_user }}"
    group: "{{ render_user }}"
    mode: '0755'

- name: Configure deadline.ini for render user (systemd service)
  ansible.builtin.copy:
    dest: /var/lib/{{ render_user }}/Thinkbox/Deadline10/deadline.ini
    owner: "{{ render_user }}"
    group: "{{ render_user }}"
    mode: '0644'
    content: |
      [Deadline]
      ConnectionType=Remote
      ProxyRoot={{ rcs_server }}:{{ rcs_port }}
      ProxyUseSSL={{ 'true' if deadline_use_ssl | default(true) | bool else 'false' }}
      ProxyValidateCertificate=false
      {% if deadline_use_ssl | default(true) | bool %}
      ProxySSLCertificate={{ client_cert_path }}
      {% endif %}
      LicenseMode=Standard

- name: Enable and start Deadline Launcher service
  ansible.builtin.systemd:
    name: deadline-launcher
    enabled: yes
    state: started
    daemon_reload: yes

# Step 6: Configure Desktop Shortcuts (System-wide)
- name: Copy Deadline desktop files to system applications
  ansible.builtin.copy:
    src: "{{ deadline_install_dir }}/{{ item }}"
    dest: /usr/share/applications/{{ item }}
    mode: '0644'
    remote_src: yes
  loop:
    - deadlinelauncher10.desktop
    - deadlinemonitor10.desktop
    - deadlineworker10.desktop
  ignore_errors: yes

- name: Fix Monitor desktop file to launch directly
  ansible.builtin.lineinfile:
    path: /usr/share/applications/deadlinemonitor10.desktop
    regexp: '^Exec='
    line: 'Exec=/opt/Thinkbox/Deadline10/bin/deadlinemonitor'
  ignore_errors: yes

- name: Fix Worker desktop file to launch directly
  ansible.builtin.lineinfile:
    path: /usr/share/applications/deadlineworker10.desktop
    regexp: '^Exec='
    line: 'Exec=/opt/Thinkbox/Deadline10/bin/deadlineslave'
  ignore_errors: yes

# Step 7: Configure for Existing AD Users
- name: Find all existing AD user home directories
  ansible.builtin.find:
    paths: "{{ ad_home_base }}"
    file_type: directory
    recurse: no
  register: ad_user_homes_raw
  failed_when: false

- name: Filter only actual user directories (UID > 400000000)
  ansible.builtin.set_fact:
    ad_user_homes:
      files: "{{ ad_user_homes_raw.files | selectattr('uid', 'gt', 400000000) | list }}"
  when: ad_user_homes_raw.files is defined

- name: Get ownership info for AD user home directories
  ansible.builtin.stat:
    path: "{{ item.path }}"
  loop: "{{ ad_user_homes.files }}"
  register: ad_user_stats
  when: ad_user_homes.files is defined and ad_user_homes.files | length > 0
  failed_when: false

- name: Create Thinkbox/Deadline10 directory for existing AD users
  ansible.builtin.file:
    path: "{{ item.stat.path }}/Thinkbox/Deadline10"
    state: directory
    owner: "{{ item.stat.pw_name }}"
    group: "{{ item.stat.gr_name }}"
    mode: '0755'
  loop: "{{ ad_user_stats.results }}"
  when:
    - ad_user_stats.results is defined
    - item.stat is defined
    - item.stat.exists
  failed_when: false

- name: Configure deadline.ini for existing AD users (with SSL)
  ansible.builtin.copy:
    dest: "{{ item.stat.path }}/Thinkbox/Deadline10/deadline.ini"
    owner: "{{ item.stat.pw_name }}"
    group: "{{ item.stat.gr_name }}"
    mode: '0644'
    content: |
      [Deadline]
      ConnectionType=Remote
      ProxyRoot={{ rcs_server }}:{{ rcs_port }}
      ProxyUseSSL=true
      ProxyValidateCertificate=false
      ProxySSLCertificate={{ client_cert_path }}
      LicenseMode=Standard
  loop: "{{ ad_user_stats.results }}"
  when:
    - ad_user_stats.results is defined
    - item.stat is defined
    - item.stat.exists
    - deadline_use_ssl | default(true) | bool
  failed_when: false

- name: Configure deadline.ini for existing AD users (without SSL)
  ansible.builtin.copy:
    dest: "{{ item.stat.path }}/Thinkbox/Deadline10/deadline.ini"
    owner: "{{ item.stat.pw_name }}"
    group: "{{ item.stat.gr_name }}"
    mode: '0644'
    content: |
      [Deadline]
      ConnectionType=Remote
      ProxyRoot={{ rcs_server }}:{{ rcs_port }}
      ProxyUseSSL=false
      LicenseMode=Standard
  loop: "{{ ad_user_stats.results }}"
  when:
    - ad_user_stats.results is defined
    - item.stat is defined
    - item.stat.exists
    - not (deadline_use_ssl | default(true) | bool)
  failed_when: false

# Step 8: Configure for Future AD Users (/etc/skel/)
- name: Create Thinkbox/Deadline10 directory in /etc/skel
  ansible.builtin.file:
    path: /etc/skel/Thinkbox/Deadline10
    state: directory
    mode: '0755'

- name: Configure deadline.ini in /etc/skel for future users (with SSL)
  ansible.builtin.copy:
    dest: /etc/skel/Thinkbox/Deadline10/deadline.ini
    mode: '0644'
    content: |
      [Deadline]
      ConnectionType=Remote
      ProxyRoot={{ rcs_server }}:{{ rcs_port }}
      ProxyUseSSL=true
      ProxyValidateCertificate=false
      ProxySSLCertificate={{ client_cert_path }}
      LicenseMode=Standard
  when: deadline_use_ssl | default(true) | bool

- name: Configure deadline.ini in /etc/skel for future users (without SSL)
  ansible.builtin.copy:
    dest: /etc/skel/Thinkbox/Deadline10/deadline.ini
    mode: '0644'
    content: |
      [Deadline]
      ConnectionType=Remote
      ProxyRoot={{ rcs_server }}:{{ rcs_port }}
      ProxyUseSSL=false
      LicenseMode=Standard
  when: not (deadline_use_ssl | default(true) | bool)
