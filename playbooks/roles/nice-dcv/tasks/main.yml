---
# ====== DCV RPM INSTALLATION ======
# Check if RPMs exist in repository Files/nice-dcv directory
- name: Check for DCV RPM files in repository
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/../../Files/nice-dcv"
    patterns: "*.rpm"
  delegate_to: localhost
  register: dcv_repo_rpms
  become: no

# Create target directory and copy RPMs if found in repository
- name: Create temporary DCV packages directory on target
  ansible.builtin.file:
    path: "{{ nice_dcv_packages_dir }}"
    state: directory
    mode: '0755'

- name: Copy DCV RPM files from repository to target
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ nice_dcv_packages_dir }}/{{ item.path | basename }}"
    mode: '0644'
  loop: "{{ dcv_repo_rpms.files }}"
  when: dcv_repo_rpms.matched > 0

- name: Display DCV installation source
  ansible.builtin.debug:
    msg: |
      {% if dcv_repo_rpms.matched > 0 %}
      ðŸ“¦ Found {{ dcv_repo_rpms.matched }} DCV RPM(s) in Files/nice-dcv/, copied to target
      {% else %}
      âš ï¸  No DCV RPMs found in Files/nice-dcv/

      Please download NICE DCV RPMs and place them in:
      Files/nice-dcv/

      Or manually place RPMs at {{ nice_dcv_packages_dir }} on the target machine
      {% endif %}

# Install RPMs from target directory (whether copied from repo or manually placed)
- name: Find DCV RPM files on target
  ansible.builtin.find:
    paths: "{{ nice_dcv_packages_dir }}"
    patterns: "*.rpm"
  register: dcv_rpms_on_target
  failed_when: false

- name: Install NICE DCV RPMs
  ansible.builtin.dnf:
    name: "{{ item.path }}"
    state: present
    disable_gpg_check: yes
  loop: "{{ dcv_rpms_on_target.files }}"
  when: dcv_rpms_on_target.files | length > 0
  register: dcv_install_result

- name: Display DCV installation result
  ansible.builtin.debug:
    msg: "{{ 'âœ… DCV RPMs installed successfully (' + (dcv_rpms_on_target.files | length | string) + ' packages)' if dcv_rpms_on_target.files | length > 0 else 'âš ï¸ DCV installation skipped - no RPM files found. To install DCV, place RPM files in Files/nice-dcv/ and re-run this playbook' }}"

- name: Clean up temporary DCV packages directory
  ansible.builtin.file:
    path: "{{ nice_dcv_packages_dir }}"
    state: absent
  when: dcv_repo_rpms.matched > 0

# ====== SSSD CONFIGURATION ======
- name: Replace sssd.conf with repository version if provided
  ansible.builtin.copy:
    src: "../../Authentication_SSSD/sssd.conf"
    dest: /etc/sssd/sssd.conf
    mode: '0600'
  notify: restart sssd

# ====== DCV SERVICE CONFIGURATION ======
- name: Create systemd override directory for dcvserver
  ansible.builtin.file:
    path: /etc/systemd/system/dcvserver.service.d
    state: directory
    mode: '0755'

- name: Set RLM_LICENSE environment variable for DCV server
  ansible.builtin.template:
    src: dcv-license.conf.j2
    dest: /etc/systemd/system/dcvserver.service.d/license.conf
    mode: '0644'
  notify: daemon reload

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Ensure DCV services are enabled and started
  ansible.builtin.systemd:
    name: dcvserver.service
    enabled: yes
    state: started

- name: Ensure unit file contains network-online.target dependency
  ansible.builtin.lineinfile:
    path: /usr/lib/systemd/system/dcvserver.service
    insertafter: '^\[Unit\]'
    line: 'After=network-online.target'
  notify: daemon reload

# ====== DCV CONFIGURATION FILES ======
- name: Ensure /etc/dcv exists
  ansible.builtin.file:
    path: /etc/dcv
    state: directory
    mode: '0755'

- name: Deploy DCV configuration file from template
  ansible.builtin.template:
    src: dcv.conf.j2
    dest: /etc/dcv/dcv.conf
    owner: root
    group: root
    mode: '0644'

- name: Deploy DCV default permissions from template
  ansible.builtin.template:
    src: default.perm.j2
    dest: /etc/dcv/default.perm
    owner: root
    group: root
    mode: '0644'

- name: Deploy PAM configuration for DCV (dcv)
  ansible.builtin.template:
    src: dcv.j2
    dest: /etc/pam.d/dcv
    owner: root
    group: root
    mode: '0644'

- name: Deploy PAM custom configuration for DCV (dcv-custom)
  ansible.builtin.template:
    src: dcv-custom.j2
    dest: /etc/pam.d/dcv-custom
    owner: root
    group: root
    mode: '0644'

# ====== FIREWALL CONFIGURATION ======
- name: Ensure firewalld is installed (for DCV)
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Ensure DCV firewall port 8443/tcp is open
  ansible.builtin.firewalld:
    port: 8443/tcp
    permanent: yes
    immediate: yes
    state: enabled
