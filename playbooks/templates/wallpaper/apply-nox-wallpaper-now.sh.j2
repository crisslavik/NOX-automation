#!/bin/bash
for user in $(ps aux | grep -v grep | grep gnome-session | awk '{print $1}' | sort | uniq); do
  if [ -n "$user" ] && [ "$user" != "gdm" ]; then
    user_id=$(id -u "$user" 2>/dev/null)
    if [ -n "$user_id" ] && [ -S "/run/user/$user_id/bus" ]; then

      # Detect user's DISPLAY (handles :0, :1, :2 for DCV sessions)
      user_display=$(ps e -u "$user" | grep -oP 'DISPLAY=\K[^ ]+' | head -n1)
      if [ -z "$user_display" ]; then
        user_display=":0"
      fi

      # Set XAUTHORITY
      user_xauth=$(eval echo ~$user)/.Xauthority

      # Apply wallpaper with proper environment
      sudo -u "$user" \
        DISPLAY="$user_display" \
        XAUTHORITY="$user_xauth" \
        DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$user_id/bus" \
        gsettings set org.gnome.desktop.background picture-uri "file://{{ wallpaper_path }}" 2>/dev/null || true

      sudo -u "$user" \
        DISPLAY="$user_display" \
        XAUTHORITY="$user_xauth" \
        DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$user_id/bus" \
        gsettings set org.gnome.desktop.background picture-uri-dark "file://{{ wallpaper_path }}" 2>/dev/null || true

      sudo -u "$user" \
        DISPLAY="$user_display" \
        XAUTHORITY="$user_xauth" \
        DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$user_id/bus" \
        gsettings set org.gnome.desktop.background picture-options 'zoom' 2>/dev/null || true

      sudo -u "$user" \
        DISPLAY="$user_display" \
        XAUTHORITY="$user_xauth" \
        DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$user_id/bus" \
        gsettings set org.gnome.desktop.screensaver picture-uri "file://{{ wallpaper_path }}" 2>/dev/null || true

      echo "âœ“ Applied wallpaper for $user on DISPLAY $user_display"
    fi
  fi
done
